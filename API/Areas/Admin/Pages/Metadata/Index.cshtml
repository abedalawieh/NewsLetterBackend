@page
@using NewsletterApp.API.Areas.Admin.Pages.ViewModels
@model NewsletterApp.API.Areas.Admin.Pages.Metadata.IndexModel
@{
    ViewData["Title"] = "System Metadata";
}

<style>
    .code-badge { font-family: 'Fira Code', monospace; background: rgba(14, 165, 233, 0.15); color: #38bdf8; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem; }
    .category-header { background: rgba(14, 165, 233, 0.08); border-left: 4px solid var(--accent, #0ea5e9); }
</style>


<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold">System Metadata</h1>
        <p class="text-secondary small">Manage system lookup values and categories</p>
    </div>
</div>

@if (Model.Categories != null)
{
    @foreach (var category in Model.Categories)
    {
        <div class="card shadow-lg overflow-hidden border-0 mb-5 bg-dark">
            <div class="card-header category-header p-4 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="text-white fw-bold mb-1">@category.Name</h5>
                    <p class="text-secondary small mb-0">@category.Description</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                </div>
            </div>
            
            @if (category.Items.Any())
            {
                var categoryTable = new DataTableViewModel
                {
                    Headers = new List<DataTableHeaderViewModel>
                    {
                        new DataTableHeaderViewModel { Label = "Code / Value", CssClass = "ps-4" },
                        new DataTableHeaderViewModel { Label = "Display Label" },
                        new DataTableHeaderViewModel { Label = "Priority", CssClass = "text-center" },
                        new DataTableHeaderViewModel { Label = "Status", CssClass = "text-center" }
                    },
                    Rows = category.Items.OrderBy(i => i.SortOrder).Select(item => new DataTableRowViewModel
                    {
                        Cells = new List<DataTableCellViewModel>
                        {
                            new DataTableCellViewModel 
                            { 
                                Value = item.Value,
                                IsHtml = false,
                                CssClass = "ps-4 code-badge"
                            },
                            new DataTableCellViewModel
                            {
                                Value = item.Label,
                                IsHtml = false
                            },
                            new DataTableCellViewModel
                            {
                                Value = $"<span class='text-secondary small'>{item.SortOrder}</span>",
                                IsHtml = true,
                                CssClass = "text-center"
                            },
                            new DataTableCellViewModel
                            {
                                Value = item.IsActive 
                                    ? "<span class='badge bg-success bg-opacity-10 text-success small'>ACTIVE</span>"
                                    : "<span class='badge bg-danger bg-opacity-10 text-danger small'>DISABLED</span>",
                                IsHtml = true,
                                CssClass = "text-center"
                            }
                        },
                        Actions = new List<TableActionViewModel>
                        {
                            new TableActionViewModel
                            {
                                Icon = "fas fa-edit",
                                Style = "info",
                                OnClick = $"openEditModal('{item.Id}', '{category.Name}', '{item.Value}', '{item.Label}', '{item.SortOrder}', '{item.IsActive}');"
                            },
                            new TableActionViewModel
                            {
                                Icon = item.IsActive ? "fas fa-power-off" : "fas fa-play",
                                Style = item.IsActive ? "warning" : "success",
                                OnClick = $"document.getElementById('toggleForm-{item.Id}').submit();"
                            },
                            new TableActionViewModel
                            {
                                Icon = "fas fa-trash-alt",
                                Style = "danger",
                                OnClick = $"openDeleteModal('{item.Id}', '{item.Label.Replace("'", "\\'")}');"
                            }
                        }
                    }).ToList()
                };
                
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Code / Value</th>
                                <th>Display Label</th>
                                <th class="text-center">Priority</th>
                                <th class="text-center">Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in category.Items.OrderBy(i => i.SortOrder))
                            {
                                <tr>
                                    <td class="ps-4">
                                        <span class="code-badge">@item.Value</span>
                                    </td>
                                    <td>@item.Label</td>
                                    <td class="text-center">
                                        <span class="text-secondary small">@item.SortOrder</span>
                                    </td>
                                    <td class="text-center">
                                        @if (item.IsActive)
                                        {
                                            <span class="badge bg-success bg-opacity-10 text-success small">ACTIVE</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger bg-opacity-10 text-danger small">DISABLED</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        
                                        <button type="button" class="btn btn-sm btn-info rounded-pill px-2" 
                                            onclick="openEditModal('@item.Id', '@category.Name', '@item.Value', '@item.Label', '@item.SortOrder', '@item.IsActive');" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        
                                        <button type="button" class="btn btn-sm btn-@(item.IsActive ? "warning" : "success") rounded-pill px-2" 
                                            onclick="document.getElementById('toggleForm-@item.Id').submit();" title="@(item.IsActive ? "Deactivate" : "Activate")">
                                            <i class="fas @(item.IsActive ? "fa-power-off" : "fa-play")"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="p-4 text-center text-secondary">
                    <i class="fas fa-inbox me-2"></i> No items in this category
                </div>
            }
        </div>
    }
}


@if (Model.Categories != null)
{
    @foreach (var category in Model.Categories)
    {
        @foreach (var item in category.Items)
        {
            <form id="toggleForm-@item.Id" method="post" asp-page-handler="ToggleStatus" asp-route-id="@item.Id" asp-route-category="@category.Name" style="display:none;"></form>
        }
    }
}


<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Edit Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Edit">
                <div class="modal-body">
                    <input type="hidden" id="editItemId" asp-for="EditItemId" />
                    <input type="hidden" id="editCategory" /> 
                    
                    
                    <div class="mb-3">
                        <label class="form-label text-secondary small">Value (Code)</label>
                        <input type="text" id="editValueDisplay" class="form-control bg-black border-secondary text-muted" disabled />
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="EditItem.Label" class="form-label text-secondary small">Display Label</label>
                        <input id="editLabel" asp-for="EditItem.Label" class="form-control bg-black border-secondary text-white" required />
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="EditItem.SortOrder" class="form-label text-secondary small">Sort Order</label>
                        <input id="editSortOrder" asp-for="EditItem.SortOrder" type="number" class="form-control bg-black border-secondary text-white" />
                    </div>

                    <div id="editIsActiveGroup" class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editIsActive" asp-for="EditItem.IsActive">
                        <label class="form-check-label text-white" for="editIsActive">Active Status</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openEditModal(id, category, value, label, sortOrder, isActive) {
            document.getElementById('editItemId').value = id;
            document.getElementById('editCategory').value = category;
            document.getElementById('editValueDisplay').value = value;
            document.getElementById('editLabel').value = label;
            document.getElementById('editSortOrder').value = sortOrder;
            document.getElementById('editIsActive').checked = (isActive === 'True' || isActive === 'true');
            
            const systemCats = ["SubscriberType", "CommunicationMethod", "Interest"];
            const isSystem = systemCats.includes(category);
            document.getElementById('editIsActiveGroup').style.display = isSystem ? 'none' : 'block';
            
            var modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }
    </script>
}
